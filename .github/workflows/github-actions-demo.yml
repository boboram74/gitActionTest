name: Send commit messages + changed files (push, robust)

on:
  push:
    branches: ['**']

jobs:
  send:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      APP_ENDPOINT: ${{ secrets.APP_ENDPOINT }}
      APP_TOKEN:    ${{ secrets.APP_TOKEN }}
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const commits = context.payload.commits || [];
            if (!commits.length) { core.info('no commits'); return; }

            const base = context.payload.before;
            const head = context.payload.after;

            const cmp = await github.rest.repos.compareCommits({
              owner, repo, base, head, per_page: 250
            });

            const MAX_DIFF_LINES = 30000;
            const simplifyPatch = (p) => {
              if (!p) return null; // 바이너리/대용량 등
              const lines = p.split('\n').filter(l => {
                if (l.startsWith('@@')) return false;           // hunk header 제거
                if (l.startsWith('+++') || l.startsWith('---')) return false; // 파일 헤더 제거
                return l.startsWith('+') || l.startsWith('-');   // 변경 라인만
              });
              const cut = lines.slice(0, MAX_DIFF_LINES);
              return cut.join('\n') + (lines.length > MAX_DIFF_LINES ? '\n--TRUNCATED--' : '');
            };

            const files = (cmp.data.files || []).map(f => ({
              filename: f.filename,
              previous_filename: f.previous_filename ?? null,
              status:   f.status,       // added | removed | modified | renamed
              additions: f.additions,
              deletions: f.deletions,
              changes:   f.changes,
              delta:    (() => {
                const label = f.previous_filename
                  ? `${f.previous_filename} -> ${f.filename}`
                  : f.filename;
                const d = simplifyPatch(f.patch);
                // 🔹 파일당 헤더 1줄 + +/- 변경 라인만
                return `# ${label}\n${d ?? '--NO-TEXTUAL-CHANGES--'}`;
              })()
            }));

            const body = {
              repo: { owner, name: repo },
              ref:  context.payload.ref,
              messages: commits.map(c => c.message),
              files
            };

            const res = await fetch(process.env.APP_ENDPOINT, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.APP_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });
            core.info(`POST -> ${res.status}`);
            if (!res.ok) core.setFailed(await res.text());
